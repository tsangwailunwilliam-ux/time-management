<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››è±¡é™ç®¡ç†ç³»çµ± (V10.0 æ——è‰¦ç‰ˆ)</title>
    <style>
        /* * =========================================
         * 1. æ ¸å¿ƒæ¨£å¼è®Šæ•¸ (æ”¯æ´æ·±è‰²æ¨¡å¼)
         * =========================================
         */
        :root {
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #343a40;
            --text-muted: #868e96;
            --border-color: #dee2e6;
            
            --color-q1-bg: #fff0f0; --color-q1-border: #ff6b6b;
            --color-q2-bg: #f0f7ff; --color-q2-border: #4dabf7;
            --color-q3-bg: #fffde7; --color-q3-border: #fcc419;
            --color-q4-bg: #fcfcfc; --color-q4-border: #ced4da;
            
            --primary-color: #339af0; 
            --personal-color: #20c997;
            --danger-color: #ff6b6b;
            --radius: 12px;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg-body: #1a1a1a;
            --bg-card: #2d2d2d;
            --text-main: #e9ecef;
            --text-muted: #adb5bd;
            --border-color: #495057;

            --color-q1-bg: #4a2626; --color-q1-border: #ff6b6b;
            --color-q2-bg: #1c3b5a; --color-q2-border: #4dabf7;
            --color-q3-bg: #4d4628; --color-q3-border: #fcc419;
            --color-q4-bg: #2d2d2d; --color-q4-border: #6c757d;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-body); color: var(--text-main);
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; transition: background 0.3s, color 0.3s;
        }

        /* Header & Controls */
        .header-row { display: flex; justify-content: space-between; width: 100%; max-width: 1000px; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-weight: 300; font-size: 1.8rem; }
        
        .top-controls { display: flex; gap: 10px; }
        .icon-btn { background: none; border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-size: 14px; display: flex; align-items: center; gap: 5px;}
        .icon-btn:hover { background: var(--border-color); }

        /* View Tabs */
        .view-tabs {
            display: flex; gap: 5px; margin-bottom: 20px;
            background: var(--border-color); padding: 4px; border-radius: 30px;
        }
        .tab-btn {
            border: none; background: transparent; padding: 8px 20px;
            border-radius: 25px; cursor: pointer; font-size: 15px; font-weight: 500;
            color: var(--text-muted); transition: all 0.3s;
        }
        .tab-btn.active[data-type="work"] { background-color: var(--bg-card); color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-btn.active[data-type="personal"] { background-color: var(--bg-card); color: var(--personal-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        /* Input Area */
        .input-group {
            background: var(--bg-card); padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
            margin-bottom: 30px; width: 100%; max-width: 900px; justify-content: center;
            border-top: 4px solid var(--primary-color); transition: border-color 0.3s, background 0.3s;
        }
        .input-group.personal-mode { border-top-color: var(--personal-color); }

        input[type="text"], input[type="date"] { 
            padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 6px; 
            flex-grow: 1; font-size: 16px; background: var(--bg-body); color: var(--text-main);
        }
        input[type="date"] { flex-grow: 0; width: 150px; }
        
        .options-wrapper { display: flex; gap: 15px; align-items: center; }
        .checkbox-wrapper, .radio-wrapper { display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none; font-size: 15px;}
        .divider { width: 1px; height: 24px; background: var(--border-color); margin: 0 5px; }

        button.primary-btn {
            background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; 
            cursor: pointer; font-size: 16px; transition: background 0.2s; white-space: nowrap;
        }
        button.primary-btn:hover { filter: brightness(1.1); }
        .input-group.personal-mode button.primary-btn { background-color: var(--personal-color); }

        /* Matrix */
        .matrix-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; width: 100%; max-width: 1000px; height: 70vh; }
        @media (max-width: 768px) { .matrix-container { grid-template-columns: 1fr; grid-template-rows: auto; height: auto; } }

        .quadrant {
            background-color: var(--bg-card); border-radius: var(--radius); padding: 15px;
            display: flex; flex-direction: column; border-top: 5px solid transparent;
            min-height: 200px; transition: transform 0.2s, background 0.3s; overflow-y: auto;
            box-shadow: var(--shadow);
        }
        #q1 { background-color: var(--color-q1-bg); border-color: var(--color-q1-border); }
        #q2 { background-color: var(--color-q2-bg); border-color: var(--color-q2-border); }
        #q3 { background-color: var(--color-q3-bg); border-color: var(--color-q3-border); }
        #q4 { background-color: var(--color-q4-bg); border-color: var(--color-q4-border); }
        
        .quadrant h3 { margin: 0 0 15px 0; font-size: 1.1rem; text-align: center; opacity: 0.8; pointer-events: none; color: var(--text-main); }

        /* Task Card */
        .task-card {
            background: var(--bg-card); padding: 12px; margin-bottom: 10px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; position: relative;
            transition: all 0.2s ease; border-left: 4px solid transparent;
        }
        .task-card:hover { box-shadow: 0 5px 10px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .task-card.completed { opacity: 0.6; transform: none; box-shadow: none; background: rgba(0,0,0,0.03); }
        .task-card.completed .task-title { text-decoration: line-through; color: var(--text-muted); }
        
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .task-title { font-weight: 500; font-size: 16px; word-break: break-all; flex-grow: 1; color: var(--text-main); }
        
        .task-meta-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; font-size: 12px; color: var(--text-muted); }
        .meta-left { display: flex; gap: 8px; align-items: center; }
        
        /* Progress Bar on Card */
        .mini-progress-track { width: 50px; height: 4px; background: var(--border-color); border-radius: 2px; overflow: hidden; display: none; }
        .mini-progress-fill { height: 100%; background: var(--personal-color); width: 0%; transition: width 0.3s; }
        .task-card.has-progress .mini-progress-track { display: block; }

        .due-date-tag { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
        .due-date-tag.overdue { color: var(--danger-color); background: rgba(255, 107, 107, 0.1); font-weight: bold; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--bg-card); width: 90%; max-width: 600px; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; max-height: 90vh; animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        input.title-edit-input { font-size: 1.4rem; font-weight: bold; border: none; background: transparent; color: var(--text-main); padding: 0; width: 100%; outline: none; }
        input.title-edit-input:focus { border-bottom: 2px solid var(--primary-color); }
        
        .modal-scroll-body { flex-grow: 1; overflow-y: auto; padding: 20px 25px; display: flex; flex-direction: column; gap: 25px; }
        .section-title { font-size: 13px; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}

        /* Logs & Images */
        .log-item { display: flex; gap: 10px; margin-bottom: 12px; align-items: flex-start; }
        .log-checkbox { margin-top: 4px; width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; }
        .log-content-box { flex-grow: 1; }
        .log-text { font-size: 15px; color: var(--text-main); transition: color 0.2s; line-height: 1.4; }
        .log-text.completed { text-decoration: line-through; color: var(--text-muted); }
        
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .image-item { position: relative; aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid var(--border-color); }
        .image-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
        .image-item:hover img { transform: scale(1.1); }
        .image-delete-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.6); color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; opacity: 0; }
        .image-item:hover .image-delete-btn { opacity: 1; }

        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        .new-log-wrapper { display: flex; gap: 10px; }
        
        /* Toast & Lightbox */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .lightbox-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 3000; justify-content: center; align-items: center; }
        .lightbox-overlay.active { display: flex; }
        .lightbox-img { max-width: 95%; max-height: 95%; border-radius: 4px; }

        /* Utility */
        .hidden-file-input { display: none; }
    </style>
</head>
<body>

    <div class="header-row">
        <h1>å››è±¡é™ç®¡ç† <span style="font-size: 0.5em; color: var(--primary-color); vertical-align: middle;">V10.0</span></h1>
        <div class="top-controls">
            <button class="icon-btn" onclick="toggleTheme()" title="åˆ‡æ›æ·±è‰²æ¨¡å¼">ğŸŒ“</button>
            <button class="icon-btn" onclick="exportData()" title="å‚™ä»½è³‡æ–™">â¬‡ åŒ¯å‡º</button>
            <button class="icon-btn" onclick="document.getElementById('import-file').click()" title="é‚„åŸè³‡æ–™">â¬† åŒ¯å…¥</button>
            <input type="file" id="import-file" class="hidden-file-input" accept=".json" onchange="importData(this)">
        </div>
    </div>

    <div class="view-tabs">
        <button class="tab-btn active" data-type="work" onclick="switchView('work')">ğŸ’¼ å·¥ä½œ</button>
        <button class="tab-btn" data-type="personal" onclick="switchView('personal')">ğŸ  ç§äºº</button>
    </div>

    <div class="input-group" id="input-group-container">
        <input type="text" id="task-input" placeholder="è¼¸å…¥å¾…è¾¦äº‹é …..." />
        <input type="date" id="task-date" title="æˆªæ­¢æ—¥æœŸ (é¸å¡«)">
        <div class="options-wrapper">
            <label class="checkbox-wrapper"><input type="checkbox" id="is-important"> é‡è¦</label>
            <label class="checkbox-wrapper"><input type="checkbox" id="is-urgent"> ç·Šæ€¥</label>
            <div class="divider"></div>
            <label class="radio-wrapper"><input type="radio" name="category" value="work" checked> å…¬äº‹</label>
            <label class="radio-wrapper"><input type="radio" name="category" value="personal"> ç§äº‹</label>
        </div>
        <button id="add-btn" class="primary-btn">æ–°å¢</button>
    </div>

    <div class="matrix-container">
        <div class="quadrant" id="q1" ondrop="drop(event)" ondragover="allowDrop(event)"><h3>ğŸ”¥ é‡è¦ä¸”ç·Šæ€¥</h3></div>
        <div class="quadrant" id="q2" ondrop="drop(event)" ondragover="allowDrop(event)"><h3>ğŸ“… é‡è¦ä½†ä¸ç·Šæ€¥</h3></div>
        <div class="quadrant" id="q3" ondrop="drop(event)" ondragover="allowDrop(event)"><h3>âš¡ ç·Šæ€¥ä½†ä¸é‡è¦</h3></div>
        <div class="quadrant" id="q4" ondrop="drop(event)" ondragover="allowDrop(event)"><h3>â˜• ä¸é‡è¦ä¹Ÿä¸ç·Šæ€¥</h3></div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <input type="text" id="modal-title-input" class="title-edit-input" onblur="updateTaskTitle()">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted);">
                    <span id="modal-created-time"></span>
                    <span id="modal-due-date"></span>
                </div>
            </div>

            <div class="modal-scroll-body">
                <!-- å­ä»»å‹™å€ -->
                <div>
                    <div class="section-title">
                        <span>âœ… å­ä»»å‹™æ¸…å–®</span>
                        <span id="progress-text" style="font-weight: normal; font-size: 12px;">0%</span>
                    </div>
                    <div id="logs-list"></div>
                </div>

                <!-- åœ–ç‰‡å€ -->
                <div>
                    <div class="section-title">
                        <span>ğŸ“· é™„ä»¶</span>
                        <label for="image-upload" style="cursor: pointer; color: var(--primary-color); font-size: 12px;">+ æ–°å¢</label>
                        <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    </div>
                    <div class="image-gallery" id="image-gallery"></div>
                </div>
            </div>

            <div class="modal-footer">
                <div class="new-log-wrapper">
                    <input type="text" id="new-log-input" placeholder="æ–°å¢å­ä»»å‹™..." style="flex-grow:1; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-body); color: var(--text-main);">
                    <button onclick="addNewLog()" style="background: var(--primary-color); color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer;">ï¼‹</button>
                </div>
                <button onclick="closeModal()" style="width: 100%; padding: 10px; background: var(--border-color); border: none; border-radius: 6px; cursor: pointer; color: var(--text-main); margin-top: 5px;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox-overlay" class="lightbox-overlay" onclick="this.classList.remove('active')">
        <img id="lightbox-img" class="lightbox-img" src="">
    </div>

    <div id="save-toast" class="toast">å·²å„²å­˜</div>

    <script>
        // === 1. æ ¸å¿ƒè®Šæ•¸èˆ‡åˆå§‹åŒ– ===
        let allTasks = []; 
        let currentView = 'work'; 
        let currentEditingTaskId = null;
        const STORAGE_KEY = 'eisenhower_v10_data'; 
        const THEME_KEY = 'eisenhower_v10_theme';

        // DOM Elements
        const taskInput = document.getElementById('task-input');
        const taskDate = document.getElementById('task-date');
        const modal = document.getElementById('detail-modal');
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadTasks();
            updateViewUI();
        });

        // === 2. ä¸»é¡Œèˆ‡è¦–åœ– ===
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem(THEME_KEY, isDark ? 'light' : 'dark');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            if (savedTheme) document.body.setAttribute('data-theme', savedTheme);
        }

        window.switchView = function(viewType) {
            currentView = viewType;
            updateViewUI();
            renderAllTasks();
        }

        function updateViewUI() {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.type === currentView));
            const inputGroup = document.getElementById('input-group-container');
            if (currentView === 'work') {
                inputGroup.classList.remove('personal-mode');
                document.querySelector('input[name="category"][value="work"]').checked = true;
            } else {
                inputGroup.classList.add('personal-mode');
                document.querySelector('input[name="category"][value="personal"]').checked = true;
            }
        }

        // === 3. ä»»å‹™ç®¡ç† (CRUD) ===
        document.getElementById('add-btn').addEventListener('click', addTask);
        taskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });

        function addTask() {
            const text = taskInput.value.trim();
            if (!text) { alert("è«‹è¼¸å…¥äº‹é …å…§å®¹ï¼"); return; }
            
            const isImportant = document.getElementById('is-important').checked;
            const isUrgent = document.getElementById('is-urgent').checked;
            const category = document.querySelector('input[name="category"]:checked').value;
            const dueDate = taskDate.value;

            let targetId = 'q4';
            if (isImportant && isUrgent) targetId = 'q1';
            else if (isImportant && !isUrgent) targetId = 'q2';
            else if (!isImportant && isUrgent) targetId = 'q3';

            const newTask = {
                id: 'task-' + Date.now(),
                text: text,
                quadrant: targetId,
                category: category,
                completed: false,
                createdTime: new Date().toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                dueDate: dueDate,
                logs: [], // å­ä»»å‹™
                images: []
            };

            allTasks.push(newTask);
            saveData();
            renderAllTasks();
            
            // Reset inputs
            taskInput.value = ''; 
            taskDate.value = '';
            document.getElementById('is-important').checked = false; 
            document.getElementById('is-urgent').checked = false;
        }

        function renderAllTasks() {
            ['q1', 'q2', 'q3', 'q4'].forEach(id => {
                const container = document.getElementById(id);
                const title = container.querySelector('h3');
                container.innerHTML = ''; container.appendChild(title);
            });

            const filteredTasks = allTasks.filter(t => t.category === currentView);
            
            filteredTasks.forEach(task => {
                const card = document.createElement('div');
                
                // è¨ˆç®—å­ä»»å‹™é€²åº¦
                const totalLogs = task.logs ? task.logs.length : 0;
                const doneLogs = task.logs ? task.logs.filter(l => l.completed).length : 0;
                const progressPercent = totalLogs > 0 ? (doneLogs / totalLogs) * 100 : 0;
                const hasProgress = totalLogs > 0;

                // æˆªæ­¢æ—¥æœŸé‚è¼¯
                let dateHtml = '';
                if (task.dueDate) {
                    const today = new Date().toISOString().split('T')[0];
                    const isOverdue = task.dueDate < today && !task.completed;
                    dateHtml = `<span class="due-date-tag ${isOverdue ? 'overdue' : ''}">ğŸ“… ${task.dueDate.slice(5)}</span>`;
                }

                card.className = `task-card ${task.completed ? 'completed' : ''} ${hasProgress ? 'has-progress' : ''}`;
                card.draggable = true;
                card.id = task.id;
                card.innerHTML = `
                    <div class="task-header">
                        <span class="task-title">${task.text}</span>
                        <input type="checkbox" ${task.completed ? 'checked' : ''} onclick="toggleTaskStatus(event, '${task.id}')" style="width:18px; height:18px; cursor:pointer;">
                    </div>
                    <div class="task-meta-row">
                        <div class="meta-left">
                            ${dateHtml}
                            ${task.images && task.images.length > 0 ? '<span>ğŸ“·</span>' : ''}
                        </div>
                        <button onclick="deleteTask(event, '${task.id}')" style="background:none; border:none; color:#adb5bd; cursor:pointer;">âœ•</button>
                    </div>
                    <div class="mini-progress-track">
                        <div class="mini-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;

                card.addEventListener('dragstart', (ev) => { ev.dataTransfer.setData("text", ev.target.id); ev.target.style.opacity = '0.5'; });
                card.addEventListener('dragend', (ev) => { ev.target.style.opacity = '1'; });
                card.addEventListener('click', (e) => { if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') openModal(task.id); });

                const container = document.getElementById(task.quadrant);
                if (task.completed) container.appendChild(card);
                else {
                    const title = container.querySelector('h3');
                    if (title && title.nextSibling) container.insertBefore(card, title.nextSibling);
                    else container.appendChild(card);
                }
            });
        }

        function toggleTaskStatus(e, id) {
            e.stopPropagation();
            const task = allTasks.find(t => t.id === id);
            if (task) { task.completed = !task.completed; saveData(); renderAllTasks(); }
        }

        function deleteTask(e, id) {
            e.stopPropagation();
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) {
                allTasks = allTasks.filter(t => t.id !== id);
                saveData(); renderAllTasks();
            }
        }

        // === 4. Modal è©³ç´°é  ===
        function openModal(id) {
            currentEditingTaskId = id;
            const task = allTasks.find(t => t.id === id);
            if (!task) return;

            document.getElementById('modal-title-input').value = task.text;
            document.getElementById('modal-created-time').innerText = "å»ºç«‹: " + task.createdTime;
            document.getElementById('modal-due-date').innerText = task.dueDate ? "æˆªæ­¢: " + task.dueDate : "";
            
            renderLogs(task);
            renderImages(task.images || []);
            modal.classList.add('active');
        }

        function updateTaskTitle() {
            const newTitle = document.getElementById('modal-title-input').value.trim();
            const task = allTasks.find(t => t.id === currentEditingTaskId);
            if (task && newTitle) {
                task.text = newTitle;
                saveData();
                renderAllTasks(); // æ›´æ–°èƒŒæ™¯å¡ç‰‡
            }
        }

        function closeModal() {
            modal.classList.remove('active');
            currentEditingTaskId = null;
        }

        // === 5. å­ä»»å‹™ (Logs) ===
        function renderLogs(task) {
            const container = document.getElementById('logs-list');
            container.innerHTML = '';
            const logs = task.logs || [];
            
            // è¨ˆç®—é€²åº¦æ–‡å­—
            const done = logs.filter(l => l.completed).length;
            const total = logs.length;
            const percent = total === 0 ? 0 : Math.round((done / total) * 100);
            document.getElementById('progress-text').innerText = `${done}/${total} (${percent}%)`;

            if (logs.length === 0) {
                container.innerHTML = '<div style="color:var(--text-muted); font-style:italic; font-size:13px;">å°šç„¡å­ä»»å‹™</div>';
                return;
            }

            logs.forEach((log, index) => {
                const div = document.createElement('div');
                div.className = 'log-item';
                div.innerHTML = `
                    <input type="checkbox" class="log-checkbox" ${log.completed ? 'checked' : ''} onchange="toggleLog(${index})">
                    <div class="log-content-box">
                        <div class="log-text ${log.completed ? 'completed' : ''}">${log.text}</div>
                    </div>
                    <button onclick="deleteLog(${index})" style="border:none; background:none; color:var(--danger-color); cursor:pointer; font-size:12px;">âœ•</button>
                `;
                container.appendChild(div);
            });
        }

        function addNewLog() {
            const input = document.getElementById('new-log-input');
            const text = input.value.trim();
            if (!text) return;
            
            const task = allTasks.find(t => t.id === currentEditingTaskId);
            if (task) {
                if (!task.logs) task.logs = [];
                task.logs.push({ text: text, completed: false });
                input.value = '';
                saveData();
                renderLogs(task);
                renderAllTasks(); // æ›´æ–°å¤–éƒ¨é€²åº¦æ¢
            }
        }

        window.toggleLog = function(index) {
            const task = allTasks.find(t => t.id === currentEditingTaskId);
            if (task) {
                task.logs[index].completed = !task.logs[index].completed;
                saveData();
                renderLogs(task);
                renderAllTasks();
            }
        }

        window.deleteLog = function(index) {
            const task = allTasks.find(t => t.id === currentEditingTaskId);
            if (task) {
                task.logs.splice(index, 1);
                saveData();
                renderLogs(task);
                renderAllTasks();
            }
        }
        
        document.getElementById('new-log-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') addNewLog(); });

        // === 6. åœ–ç‰‡è™•ç† ===
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    // ç°¡å–®å£“ç¸®é‚è¼¯
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 800;
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } }
                        else { if (h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        
                        const base64 = canvas.toDataURL('image/jpeg', 0.7);
                        const task = allTasks.find(t => t.id === currentEditingTaskId);
                        if (task) {
                            if(!task.images) task.images = [];
                            task.images.push(base64);
                            saveData();
                            renderImages(task.images);
                            renderAllTasks();
                        }
                    }
                }
                reader.readAsDataURL(file);
                input.value = '';
            }
        }

        function renderImages(images) {
            const gallery = document.getElementById('image-gallery');
            gallery.innerHTML = '';
            images.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'image-item';
                div.innerHTML = `
                    <img src="${src}" onclick="document.getElementById('lightbox-img').src='${src}'; document.getElementById('lightbox-overlay').classList.add('active');">
                    <button class="image-delete-btn" onclick="deleteImage(${idx})">âœ•</button>
                `;
                gallery.appendChild(div);
            });
        }

        window.deleteImage = function(index) {
            if(!confirm("åˆªé™¤æ­¤ç…§ç‰‡ï¼Ÿ")) return;
            const task = allTasks.find(t => t.id === currentEditingTaskId);
            if (task) {
                task.images.splice(index, 1);
                saveData();
                renderImages(task.images);
                renderAllTasks();
            }
        }

        // === 7. æ‹–æ”¾èˆ‡è³‡æ–™å­˜å– ===
        function allowDrop(ev) { ev.preventDefault(); }
        function drop(ev) {
            ev.preventDefault();
            const quadrant = ev.target.closest('.quadrant');
            const taskId = ev.dataTransfer.getData("text");
            if (quadrant && taskId) {
                const task = allTasks.find(t => t.id === taskId);
                if (task && task.quadrant !== quadrant.id) {
                    task.quadrant = quadrant.id;
                    saveData();
                    renderAllTasks();
                }
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allTasks));
                const toast = document.getElementById('save-toast');
                toast.style.opacity = '1';
                setTimeout(() => toast.style.opacity = '0', 1500);
            } catch (e) { alert("å„²å­˜ç©ºé–“å·²æ»¿ï¼Œè«‹åˆªé™¤éƒ¨åˆ†åœ–ç‰‡ï¼"); }
        }

        function loadTasks() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                allTasks = JSON.parse(data);
                // å…¼å®¹æ€§æª¢æŸ¥
                allTasks.forEach(t => {
                    if(!t.logs) t.logs = [];
                    if(!t.images) t.images = [];
                });
                renderAllTasks();
            }
        }

        // === 8. åŒ¯å‡ºèˆ‡åŒ¯å…¥ ===
        window.exportData = function() {
            const dataStr = JSON.stringify(allTasks);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `eisenhower_backup_${new Date().toISOString().slice(0,10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        if(confirm("é€™å°‡è¦†è“‹ç›®å‰çš„ä»»å‹™è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                            allTasks = json;
                            saveData();
                            renderAllTasks();
                            alert("åŒ¯å…¥æˆåŠŸï¼");
                        }
                    } else { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
                } catch (err) { alert("ç„¡æ³•è®€å–æª”æ¡ˆ"); }
            };
            reader.readAsText(file);
            input.value = '';
        }
    </script>
</body>
</html>

